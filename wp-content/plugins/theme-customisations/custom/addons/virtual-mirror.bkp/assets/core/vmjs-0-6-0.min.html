<!doctype html>
<html>
<head>
<title>Virtual Mirror</title>
<meta charset="utf-8">
<link rel="localization" hreflang="en" href="../ln/en.json" type="application/vnd.oftn.l10n+json">
<link rel="localization" hreflang="de" href="../ln/de.json" type="application/vnd.oftn.l10n+json">
<link rel="localization" hreflang="fr" href="../ln/fr.json" type="application/vnd.oftn.l10n+json">
<link rel="localization" hreflang="es" href="../ln/es.json" type="application/vnd.oftn.l10n+json">
<link rel="localization" hreflang="pt" href="../ln/pt.json" type="application/vnd.oftn.l10n+json">
<link rel="localization" hreflang="nl" href="../ln/nl.json" type="application/vnd.oftn.l10n+json">
<link rel="localization" hreflang="ru" href="../ln/ru.json" type="application/vnd.oftn.l10n+json">
<link rel="localization" hreflang="ar" href="../ln/ar.json" type="application/vnd.oftn.l10n+json">
<link rel="localization" hreflang="he" href="../ln/he.json" type="application/vnd.oftn.l10n+json">
<link rel="localization" hreflang="gr" href="../ln/gr.json" type="application/vnd.oftn.l10n+json">
<link href="./styles/sm-core-css.css" rel="stylesheet">
<link href="./styles/sm-vm/sm-vm.css" rel="stylesheet">
<link href="./styles/toastr.min.css" rel="stylesheet">
<!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
<style>@import url(https://fonts.googleapis.com/css?family=Droid+Sans:400,700);body{font-family:'Droid Sans';background-color:#fff;top:0;width:482px;margin:1px auto;overflow:hidden}#content{top:0;width:482px;margin:1px auto}#container{position:relative;width:482px;height:514px}#videostream{display:none}#overlay{position:absolute;top:0;left:0}#filedialog{display:none}.spinner{position:absolute;top:0 left: 0}.hide{display:none}.nohide{display:block}</style>
</head>
<body>
<script src="../js/vm-config.js"></script>
<script src="../js/i18n-init.js"></script>
<script src="../js/i18n.js"></script>
<script src="../js/clmtrackr.min.js"></script>
<script src="./ext_js/utils.js"></script>
<script src="./ext_js/jquery.min.js"></script>
<script src="./ext_js/pica.min.js"></script>
<script src="./ext_js/jquery.smartmenus.min.js"></script>
<script src="./ext_js/Blob.js"></script>
<script src="./ext_js/canvas-toBlob.js"></script>
<script src="./ext_js/FileSaver.min.js"></script>
<script src="./ext_js/heartcode-canvasloader-min.js"></script>
<script src="./ext_js/toastr.min.js"></script>
<div id="content">
<nav id="main-nav" role="navigation">
<div id="vm-header">Virtual Mirror</div>
<ul id="main-menu" class="sm sm-vm">
<li><a href="#"><img src="media/menu-white.png" width="28" height="28" alt=""></a>
<ul>
<li><a id="usephoto" href="#" onclick="return usePhoto(!1),!1">Use Photo</a></li>
<li><a id="loadphoto" href="#" onclick="return document.getElementById(&#34;filedialog&#34;).click(),!1">Load Photo</a></li>
<li><a id="deletephoto" href="#" onclick="return deleteUserPic(),!1" class="disabled">Delete Photo</a></li>
<li><a id="usevideo" href="#" onclick="return useVideo(),!1" class="enabled">Use Video</a></li>
<li><a id="stopvideo" href="#" onclick="return stopVideo(),!1" class="disabled">Stop Video</a></li>
<li><a id="savesnap" href="#" onclick="return saveSnap(),!1" class="disabled">Save Snapshot</a></li>
</ul>
</li>
</ul>
</nav>
<div id="container">
<video id="videostream" preload="auto" loop playsinline autoplay></video>
<canvas id="overlay"></canvas>
<div id="canvasloader-container" class="spinner"></div>
</div>
<input type="file" id="filedialog" name="files[]" accept="image/*">
</div>
<script>"use strict";function addLoadEvent(e){var t=window.onload;"function"!=typeof window.onload?window.onload=e:window.onload=function(){t&&t(),e()}}function getQueryVar(e){for(var t=window.location.search.substring(1),a=t.split("&"),o=0;o<a.length;o++){var n=a[o].split("=");if(n[0]==e)return n[1]}return!1}function extension(e){var t=e.lastIndexOf("."),a=e.length;if(t!=-1&&a!=t+1)var o=e.split("."),n=o.length,i=o[n-1].toLowerCase();else i="";return i}function setBlendMode(){blend="png"!=extension(frameFile)}function setCaching(e){if("on"==vmConf.STOP_BROWSER_CACHE){e+="?"+(Math.floor(Math.random()*(1e8-5))+5)}return e}function forMobile(){if(sessionStorage.desktop)return!1;if(localStorage.mobile)return!0;var e=["iphone","ipad","android","blackberry","nokia","opera mini","windows mobile","windows phone","iemobile"];for(var t in e)if(navigator.userAgent.toLowerCase().indexOf(e[t].toLowerCase())>0)return!0;return!1}function setDimension(e,t){onVideo?("mobile"==e?"landscape"==t?(gw=420,gh=315):(gw=330,gh=440):"desktop"==e&&(gw=480,gh=360),vid.setAttribute("width",gw),vid.setAttribute("height",gh),overlay.setAttribute("width",gw),overlay.setAttribute("height",gh)):(gw=384,gh=446),offsetScale=384/gw;var a=gw+2;document.getElementById("content").style.width=a+"px";var o=135;o+=(gw-384)/2,document.getElementById("vm-header").style.left=o+"px"}function getMobileVideoOrientation(){forMobile()&&onVideo&&(getOrientation(),window.addEventListener("orientationchange",function(){getOrientation()}))}function getOrientation(){90==Math.abs(window.orientation)?setDimension("mobile","landscape"):setDimension("mobile","portrait")}function cropImage(e){var t=e.width,a=e.height,o=document.createElement("canvas");o.setAttribute("width",t),o.setAttribute("height",a);var n=o.getContext("2d");n.drawImage(e,0,0);var i=n.getImageData(0,0,t,a),r=i.data,s=function(e,a){var o=t*a+e;return{red:r[4*o],green:r[4*o+1],blue:r[4*o+2],opacity:r[4*o+3]}},d=function(e){return e.red>200&&e.green>200&&e.blue>200},l=function(e){for(var o=e?1:-1,n=e?0:a-1;e?n<a:n>-1;n+=o)for(var i=0;i<t;i++){var r=s(i,n);if(!d(r))return e?n:Math.min(n+1,a-1)}return null},m=function(e){for(var o=e?1:-1,n=e?0:t-1;e?n<t:n>-1;n+=o)for(var i=0;i<a;i++){var r=s(n,i);if(!d(r))return e?n:Math.min(n+1,t-1)}return null},c=l(!0),f=l(!1),g=m(!0),u=m(!1),h=u-g,v=f-c;return o.setAttribute("width",h),o.setAttribute("height",v),o.getContext("2d").drawImage(e,g,c,h,v,0,0,h,v),o}function setFrameSize(e){croppedFrameImg.width>vmConf.AVERAGE_FRAME_SIZE&&(initRatio=gw/croppedFrameImg.width),initRatio+=computeFrameSize(frameSize),initRatio+=vmConf.OFFSET_SCALE*initRatio,initRatio*=offsetScale,frameHolder.setAttribute("width",croppedFrameImg.width*initRatio),frameHolder.setAttribute("height",croppedFrameImg.height*initRatio),fhX=frameHolder.width/2,fhY=frameHolder.height/2,pica.resizeCanvas(rawFrame,frameHolder,{quality:3,alpha:!0},function(){0==onVideo&&(overlayCtx.clearRect(0,0,gw,gh),overlayCtx.drawImage(faceImg,0,0,gw,gh)),1==e?0==hasUserPic?showFrameAtDefaultPosition():showFrame(positions[16][0],positions[16][1],positions[20][0],positions[20][1],positions[32][0],positions[32][1],positions[27][0],positions[27][1],positions[33][0]):0==hasUserPic&&showFrameAtDefaultPosition()})}function showFrameAtDefaultPosition(){hideSpinbox(),showFrame(vmConf.leftBrowX,vmConf.leftBrowY,vmConf.rightBrowX,vmConf.rightBrowY,vmConf.leftEyeX,vmConf.leftEyeY,vmConf.rightEyeX,vmConf.rightEyeY,vmConf.mouthNoseCenter)}function loadFrame(e){frameImg.onload=function(){croppedFrameImg=1==blend?cropImage(frameImg):frameImg,rawFrame.width=croppedFrameImg.width,rawFrame.height=croppedFrameImg.height,rawFrame.getContext("2d").drawImage(croppedFrameImg,0,0),frameHolder=document.createElement("canvas"),frame=document.createElement("canvas"),frameCtx=frame.getContext("2d"),frame.setAttribute("width",480),frame.setAttribute("height",512),1==e&&(setBlendMode(),setFrameSize(!0))},frameImg.onerror=function(){toastr.error("Error loading as image: "+this.src)},frameImg.crossOrigin="Anonymous",frameImg.src=frameFile}function replaceFrame(e,t,a){frameFile=setCaching(e),frameName=t,frameSize=a,frameImg=new Image,loadFrame(!0)}function usePhoto(e){overlayCtx.clearRect(0,0,gw,gh),flipOff(),onVideo=!1,setDimension("desktop","landscape"),overlay.setAttribute("width",gw),overlay.setAttribute("height",gh),overlay.style.border="1px solid "+globalColRgb,document.getElementById("usephoto").className="disabled",document.getElementById("loadphoto").className="enabled",document.getElementById("savesnap").className="disabled",document.getElementById("usevideo").className=1==e?"disabled":"enabled",document.getElementById("stopvideo").className="disabled",initPhoto(),tracker=null,tracker=new clm.tracker({searchWindow:8,stopOnConvergence:!0}),tracker.init(),checkUserPic(),localStorage.setItem("videoMode","off")}function initPhoto(){document.addEventListener("clmtrackrNotFound",function(){0==onVideo&&(tracker.stop(),hideSpinbox(),toastr.error(L("DETECTOR_FAIL")))},!1),document.addEventListener("clmtrackrLost",function(){0==onVideo&&(tracker.stop(),hideSpinbox(),toastr.error(L("DETECTOR_FAIL")))},!1),document.addEventListener("clmtrackrConverged",function(){0==onVideo&&drawToPhoto()},!1)}function drawToPhoto(){0==cnt&&(positions=tracker.getCurrentPosition(),hideSpinbox(),showFrame(positions[16][0],positions[16][1],positions[20][0],positions[20][1],positions[32][0],positions[32][1],positions[27][0],positions[27][1],positions[33][0]),cnt++)}function checkUserPic(){var e=localStorage.getItem("userpic");hasUserPic=null!=e,hasUserPic?(handleUserPic(e,-3,!1),document.getElementById("deletephoto").className="enabled",document.getElementById("savesnap").className="enabled"):loadDefaultModel()}function handleUserPic(e,t,a){faceImg=new Image,faceImg.onload=function(){var e=faceImg.width,o=faceImg.height,n=o/e;if(384!=e&&(e=384,o=Math.round(e*n)),overlay.setAttribute("width",e),overlay.setAttribute("height",o),showSpinbox(e,o),t>4&&t<9&&(384!=o&&(o=384,e=Math.round(o/n)),overlay.setAttribute("width",o),overlay.setAttribute("height",e),showSpinbox(o,e)),gw=e,gh=o,setFrameSize(!1),switchSrcOrientation(t,overlayCtx),overlayCtx.drawImage(faceImg,0,0,gw,gh),1==a){var i=overlay.toDataURL();localStorage.base64size=i.length,localStorage.setItem("userpic",i)}t>1&&t<9?checkUserPic():startTrackOnImage()},faceImg.src=e}function switchSrcOrientation(e,t){switch(e){case 2:t.transform(-1,0,0,1,gw,0);break;case 3:t.transform(-1,0,0,-1,gw,gh);break;case 4:t.transform(1,0,0,-1,0,gh);break;case 5:t.transform(0,1,1,0,0,0);break;case 6:t.transform(0,1,-1,0,gh,0);break;case 7:t.transform(0,-1,-1,0,gh,gw);break;case 8:t.transform(0,-1,1,0,0,gw)}}function loadDefaultModel(){setDimension("desktop","landscape"),faceImg=new Image,faceImg.onload=function(){showSpinbox(gw,gh),overlay.setAttribute("width",faceImg.width),overlay.setAttribute("height",faceImg.height),overlayCtx.drawImage(faceImg,0,0,faceImg.width,faceImg.height),setFrameSize(!1)},faceImg.src="male"==getQueryVar("gender")?vmConf.defaultModelMale:vmConf.defaultModelFemale}function startTrackOnImage(){cnt=0,tracker.start(overlay)}function handleFileSelect(e){var t=e.target.files;fileList=[];for(var a=0;a<t.length;a++)t[a].type.match("image.*")&&fileList.push(t[a]);t.length>0&&(fileIndex=0),loadUserPic()}function loadUserPic(){fileList.indexOf(fileIndex)<0&&getOrientationFromExif(fileList[fileIndex],function(e){var t=new FileReader;t.onload=function(){return function(t){handleUserPic(t.target.result,e,!0)}}(fileList[fileIndex]),t.readAsDataURL(fileList[fileIndex]),hasUserPic=!0,tracker.reset(),document.getElementById("usephoto").className="disabled",document.getElementById("deletephoto").className="enabled",document.getElementById("savesnap").className="enabled"})}function getOrientationFromExif(e,t){var a=new FileReader;a.onload=function(e){var a=new DataView(e.target.result);if(65496!=a.getUint16(0,!1))return t(-2);for(var o=a.byteLength,n=2;n<o;){var i=a.getUint16(n,!1);if(n+=2,65505==i){if(1165519206!=a.getUint32(n+=2,!1))return t(-1);var r=18761==a.getUint16(n+=6,!1);n+=a.getUint32(n+4,r);var s=a.getUint16(n,r);n+=2;for(var d=0;d<s;d++)if(274==a.getUint16(n+12*d,r))return t(a.getUint16(n+12*d+8,r))}else{if(65280!=(65280&i))break;n+=a.getUint16(n,!1)}}return t(-1)},a.readAsArrayBuffer(e)}function deleteUserPic(){document.getElementById("usephoto").className="disabled",document.getElementById("deletephoto").className="disabled",document.getElementById("usevideo").className="enabled",document.getElementById("savesnap").className="disabled",tracker.reset(),localStorage.removeItem("userpic"),usePhoto()}function useVideo(){flipOn(),onVideo=!0,setDimension("desktop","landscape"),getMobileVideoOrientation(),overlay.style.border="1px solid "+globalColRgb,setFrameSize(!1),document.getElementById("usephoto").className="disabled",document.getElementById("loadphoto").className="disabled",document.getElementById("deletephoto").className="disabled",document.getElementById("usevideo").className="disabled",document.getElementById("stopvideo").className="enabled",document.getElementById("savesnap").className="enabled",initVideo()}function initVideo(){navigator.getUserMedia=navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia||navigator.msGetUserMedia,window.URL=window.URL||window.webkitURL||window.msURL||window.mozURL;var e={audio:!1,video:!0};navigator.mediaDevices?navigator.mediaDevices.getUserMedia(e).then(videoSuccess).catch(videoFail):navigator.getUserMedia&&navigator.getUserMedia(e,videoSuccess,videoFail)}function videoSuccess(e){"srcObject"in vid?vid.srcObject=e:vid.src=window.URL&&window.URL.createObjectURL(e),localstream=e,vid.play(),localStorage.setItem("videoMode","on"),tracker=null,tracker=new clm.tracker({useWebGL:!0}),tracker.init(),tracker.start(vid),drawToVideo()}function videoFail(){toastr.error(L("NO_CAM_FOUND")),toastr.success(L("ENABLE_PHOTO_MODE")),usePhoto(!0)}function drawToVideo(){cancelReqId=requestAnimFrame(drawToVideo),overlayCtx.drawImage(vid,0,0,gw,gh),tracker.getScore()>.34?(positions=tracker.getCurrentPosition(),positions&&(hideSpinbox(),showFrame(positions[16][0],positions[16][1],positions[20][0],positions[20][1],positions[32][0],positions[32][1],positions[27][0],positions[27][1],positions[33][0]))):showSpinbox(gw,gh)}function stopVideo(){cancelRequestAnimFrame(cancelReqId),onVideo=!1,hideSpinbox(),vid.pause(),tracker.stop(),localstream.getTracks()[0].stop(),document.getElementById("usephoto").className="enabled",document.getElementById("loadphoto").className="disabled",document.getElementById("usevideo").className="enabled",document.getElementById("stopvideo").className="disabled",document.getElementById("savesnap").className="enabled"}function showFrame(e,t,a,o,n,i,r,s,d){var l=(n+(r-n)/2+d)/2,m=(t+o)/2,c=(e-a)/130;l+=vmConf.OFFSET_X*c,m+=vmConf.OFFSET_Y*c;var f=Math.tan((i-s)/(n-r))+Math.PI/180;frameCtx.setTransform(1,0,0,1,0,0),frameCtx.clearRect(0,0,gw,gh),frameCtx.translate(l,m),frameCtx.scale(c,c),frameCtx.rotate(f),frameCtx.drawImage(frameHolder,-fhX,-fhY),1==blend&&(overlayCtx.globalCompositeOperation=blendMode[0]),overlayCtx.drawImage(frame,0,0),1==blend&&(overlayCtx.globalCompositeOperation=blendMode[1])}function computeFrameSize(e){return e>0?.005*e+-.65:0}function showSpinbox(e,t){var a=document.getElementById("canvasLoader");a.style.position="absolute",a.style.left=e/2+spinnerCanvasLoader.getDiameter()*-.5+"px",a.style.top=t/2-navbarH+spinnerCanvasLoader.getDiameter()*-.5+"px",spinnerCanvasLoader.show()}function hideSpinbox(){spinnerCanvasLoader.hide()}function flipOn(){flip=!0,$(overlay).css({OTransform:"scaleX(-1)",webkitTransform:"scaleX(-1)",transform:"scaleX(-1)","ms-filter":"fliph",filter:"fliph"})}function flipOff(){flip=!1,$(overlay).css({OTransform:"",webkitTransform:"",transform:"","ms-filter":"",filter:""})}function saveSnap(){saveShot(overlay,gw,gh)}function saveShot(e,t,a){var o=document.createElement("canvas");o.width=t,o.height=a;var n=o.getContext("2d");flip&&(n.translate(t,0),n.scale(-1,1)),n.drawImage(e,0,0),o.toBlob(function(e){var t=decodeURIComponent(frameName);t=t.split(" ").join("-"),saveAs(e,t+".png",!0)})}addLoadEvent(i18nInit),$(function(){$("#main-menu").smartmenus({subMenusSubOffsetX:1,subMenusSubOffsetY:-8,subIndicators:!1})});var onVideo="on"==localStorage.getItem("videoMode");0==onVideo?addLoadEvent(usePhoto):(addLoadEvent(useVideo),addLoadEvent(getMobileVideoOrientation));var frameFile=getQueryVar("frameFile")?getQueryVar("frameFile"):vmConf.defaultFrame,blendMode=["multiply","source-over"],blend;setBlendMode(),frameFile=setCaching(frameFile);var frameName=getQueryVar("frameName")?getQueryVar("frameName"):vmConf.defaultFrameName,frameSize=getQueryVar("frameSize")?getQueryVar("frameSize"):vmConf.defaultFrameSize,rawFrame=document.createElement("canvas"),croppedFrameImg,frameHolder,initRatio,frame,frameCtx,fhX,fhY,frameImg=new Image;loadFrame(!1);var defaultW=384,defaultH=446,gw,gh,maxW=480,maxH=512,faceImg,vid=document.getElementById("videostream"),localstream,offsetScale,cnt,flip,overlay=document.getElementById("overlay");overlay.style.backgroundColor="#ffffff";var globalColRgb=$("#vm-header").css("background-color"),overlayCtx=overlay.getContext("2d"),hasUserPic,tracker,cancelReqId,positions,navbarH=document.getElementById("vm-header").offsetHeight,spinnerCanvasLoader=new CanvasLoader("canvasloader-container");spinnerCanvasLoader.setColor("#d3d3d3"),spinnerCanvasLoader.setShape("square"),spinnerCanvasLoader.setDiameter(52),spinnerCanvasLoader.setDensity(12),spinnerCanvasLoader.setRange(1),spinnerCanvasLoader.setFPS(12),spinnerCanvasLoader.setSpeed(1),toastr.options={positionClass:"toast-top-center",extendedTimeOut:"5000",newestOnTop:!1,preventDuplicates:!0};var fileList,fileIndex;window.File&&window.FileReader&&window.FileList&&document.getElementById("filedialog").addEventListener("change",handleFileSelect,!1)</script>
</body>
</html>
